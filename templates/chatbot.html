{% extends "base.html" %}

{% block title %}AI Chatbot - InvestIQ{% endblock %}

{% block content %}
<div class="page-header">
    <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;">
        <i class="fas fa-comments"></i> AI Financial Chatbot
    </h1>
    <p style="color: var(--gray); font-size: 1.1rem;">Ask Me Anything About Finance</p>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Chat Section -->
    <div class="card" style="min-height: 600px; display: flex; flex-direction: column;">
        <div class="card-header">
            <div class="card-icon" style="background: linear-gradient(135deg, #8B5CF6, #7C3AED);">
                <i class="fas fa-robot"></i>
            </div>
            <div class="card-title">Chat with InvestIQ AI</div>
        </div>
        
        <!-- Chat Messages -->
        <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 1.5rem; background: #F9FAFB; border-radius: 10px; margin-bottom: 1rem; max-height: 500px;">
            <div class="chat-message bot-message">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-text">
                        Hello! I'm InvestIQ, your AI financial advisor. I can help you with questions about stocks, mutual funds, savings strategies, and financial planning. What would you like to know?
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Input -->
        <div style="display: flex; gap: 1rem;">
            <input 
                type="text" 
                id="chatInput" 
                class="form-input" 
                placeholder="Ask about stocks, mutual funds, savings..."
                onkeypress="if(event.key === 'Enter') sendMessage()"
                style="flex: 1;"
            >
            <button onclick="sendMessage()" class="btn btn-success">
                <i class="fas fa-paper-plane"></i> Send
            </button>
        </div>
        
        <button onclick="clearChat()" class="btn" style="margin-top: 1rem; background: #EF4444; color: white;">
            <i class="fas fa-trash"></i> Clear Chat
        </button>
    </div>
    
    <!-- Sample Questions -->
    <div class="card">
        <div class="card-header">
            <div class="card-icon" style="background: linear-gradient(135deg, #10B981, #059669);">
                <i class="fas fa-lightbulb"></i>
            </div>
            <div class="card-title">Sample Questions</div>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <button onclick="askQuestion('What is the difference between SIP and lump sum investment?')" 
                    class="sample-question">
                <i class="fas fa-question-circle"></i>
                What is the difference between SIP and lump sum?
            </button>
            
            <button onclick="askQuestion('How should I diversify my investment portfolio?')" 
                    class="sample-question">
                <i class="fas fa-question-circle"></i>
                How should I diversify my portfolio?
            </button>
            
            <button onclick="askQuestion('Explain different types of mutual fund categories')" 
                    class="sample-question">
                <i class="fas fa-question-circle"></i>
                Explain mutual fund categories
            </button>
            
            <button onclick="askQuestion('What is a good savings rate for my income?')" 
                    class="sample-question">
                <i class="fas fa-question-circle"></i>
                What is a good savings rate?
            </button>
            
            <button onclick="askQuestion('How do I calculate emergency fund requirements?')" 
                    class="sample-question">
                <i class="fas fa-question-circle"></i>
                How to calculate emergency fund?
            </button>
            
            <button onclick="askQuestion('What are the tax benefits of ELSS funds?')" 
                    class="sample-question">
                <i class="fas fa-question-circle"></i>
                Tax benefits of ELSS funds?
            </button>
            
            <button onclick="askQuestion('Should I invest in stocks or mutual funds?')" 
                    class="sample-question">
                <i class="fas fa-question-circle"></i>
                Stocks vs Mutual Funds?
            </button>
            
            <button onclick="askQuestion('What is rupee cost averaging?')" 
                    class="sample-question">
                <i class="fas fa-question-circle"></i>
                What is rupee cost averaging?
            </button>
        </div>
    </div>
</div>

<style>
.chat-message {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: white;
    flex-shrink: 0;
}

.bot-message .message-avatar {
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
}

.user-message {
    flex-direction: row-reverse;
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #10B981, #059669);
}

.message-content {
    flex: 1;
}

.message-text {
    background: white;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    line-height: 1.6;
    word-wrap: break-word;
}

.user-message .message-text {
    background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
}

.sample-question {
    padding: 1rem;
    background: white;
    border: 2px solid #E5E7EB;
    border-radius: 10px;
    text-align: left;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--dark);
    font-weight: 500;
}

.sample-question:hover {
    border-color: #10B981;
    background: #F0FDF4;
    transform: translateX(5px);
}

.sample-question i {
    color: #10B981;
    font-size: 1.2rem;
}

.typing-indicator {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem 0;
}

.typing-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #10B981;
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

#chatMessages {
    scrollbar-width: thin;
    scrollbar-color: #10B981 #F3F4F6;
}

#chatMessages::-webkit-scrollbar {
    width: 8px;
}

#chatMessages::-webkit-scrollbar-track {
    background: #F3F4F6;
    border-radius: 10px;
}

#chatMessages::-webkit-scrollbar-thumb {
    background: #10B981;
    border-radius: 10px;
}

#chatMessages::-webkit-scrollbar-thumb:hover {
    background: #059669;
}
</style>

<script>
let chatHistory = [];

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    askQuestion(message);
    input.value = '';
}

async function askQuestion(question) {
    const chatMessages = document.getElementById('chatMessages');
    
    // Add user message
    const userMessageHTML = `
        <div class="chat-message user-message">
            <div class="message-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="message-content">
                <div class="message-text">${escapeHtml(question)}</div>
            </div>
        </div>
    `;
    chatMessages.insertAdjacentHTML('beforeend', userMessageHTML);
    
    // Add typing indicator
    const typingHTML = `
        <div class="chat-message bot-message" id="typingIndicator">
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <div class="message-text">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
    chatMessages.insertAdjacentHTML('beforeend', typingHTML);
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Save to history
    chatHistory.push({ role: 'user', content: question });
    
    try {
        // Call real Gemini API through backend
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: question })
        });
        
        const result = await response.json();
        
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
        
        if (result.success) {
            const botMessageHTML = `
                <div class="chat-message bot-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">${escapeHtml(result.response)}</div>
                    </div>
                </div>
            `;
            chatMessages.insertAdjacentHTML('beforeend', botMessageHTML);
            
            // Save to history
            chatHistory.push({ role: 'assistant', content: result.response });
        } else {
            const errorHTML = `
                <div class="chat-message bot-message">
                    <div class="message-avatar">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text" style="background: #FEE2E2; color: #991B1B;">
                            Error: ${escapeHtml(result.error || 'Failed to get response')}
                        </div>
                    </div>
                </div>
            `;
            chatMessages.insertAdjacentHTML('beforeend', errorHTML);
        }
        
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
    } catch (error) {
        console.error('Error:', error);
        
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
        
        const errorHTML = `
            <div class="chat-message bot-message">
                <div class="message-avatar">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="message-content">
                    <div class="message-text" style="background: #FEE2E2; color: #991B1B;">
                        Sorry, I encountered an error. Please try again.
                    </div>
                </div>
            </div>
        `;
        chatMessages.insertAdjacentHTML('beforeend', errorHTML);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

function getSimulatedResponse(question) {
    const lowerQuestion = question.toLowerCase();
    
    // SIP vs Lump Sum
    if (lowerQuestion.includes('sip') && lowerQuestion.includes('lump')) {
        return 'SIP (Systematic Investment Plan) involves investing a fixed amount regularly (monthly/quarterly), while lump sum is investing a large amount at once.\n\n‚úÖ SIP Benefits:\n‚Ä¢ Rupee cost averaging\n‚Ä¢ Disciplined investing\n‚Ä¢ Lower risk from market timing\n‚Ä¢ Suitable for salaried individuals\n\n‚úÖ Lump Sum Benefits:\n‚Ä¢ Higher potential returns in bull markets\n‚Ä¢ Lower transaction costs\n‚Ä¢ Suitable when markets are low\n\nRecommendation: For most investors, SIP is better as it reduces timing risk and builds discipline.';
    }
    
    // Portfolio Diversification
    if (lowerQuestion.includes('diversif')) {
        return 'Portfolio diversification is spreading investments across different asset classes to reduce risk.\n\nüìä Recommended Asset Allocation:\n\nüîπ Conservative (Low Risk):\n‚Ä¢ 60% Debt Funds\n‚Ä¢ 30% Large-cap Equity\n‚Ä¢ 10% Gold/Liquid\n\nüîπ Balanced (Medium Risk):\n‚Ä¢ 50% Equity Funds\n‚Ä¢ 30% Debt Funds\n‚Ä¢ 10% Gold\n‚Ä¢ 10% International\n\nüîπ Aggressive (High Risk):\n‚Ä¢ 70% Equity (Mix of large, mid, small cap)\n‚Ä¢ 20% Debt\n‚Ä¢ 10% Alternatives\n\nRemember: Rebalance your portfolio every 6-12 months!';
    }
    
    // Mutual Fund Categories
    if (lowerQuestion.includes('mutual fund') && lowerQuestion.includes('categor')) {
        return 'Mutual funds are categorized based on investment strategy:\n\n1Ô∏è‚É£ Equity Funds (High Risk, High Return)\n‚Ä¢ Large Cap - Top 100 companies\n‚Ä¢ Mid Cap - 101-250 companies\n‚Ä¢ Small Cap - Below 250\n‚Ä¢ Multi-cap - Mix of all\n\n2Ô∏è‚É£ Debt Funds (Low Risk, Stable Returns)\n‚Ä¢ Liquid Funds - Very short term\n‚Ä¢ Short Duration - 1-3 years\n‚Ä¢ Corporate Bond - Company bonds\n\n3Ô∏è‚É£ Hybrid Funds (Medium Risk)\n‚Ä¢ Balanced - Mix of equity & debt\n‚Ä¢ Aggressive - More equity\n‚Ä¢ Conservative - More debt\n\n4Ô∏è‚É£ ELSS (Tax Saving)\n‚Ä¢ 3-year lock-in\n‚Ä¢ 80C deduction up to ‚Çπ1.5L\n\nChoose based on your risk appetite and investment horizon!';
    }
    
    // Savings Rate
    if (lowerQuestion.includes('savings rate')) {
        return 'A healthy savings rate depends on your income and goals:\n\nüí∞ Recommended Savings Rates:\n\n‚Ä¢ Minimum: 20% of monthly income\n‚Ä¢ Good: 30-40% of monthly income\n‚Ä¢ Excellent: 50%+ of monthly income\n\nüìã The 50/30/20 Rule:\n‚Ä¢ 50% - Needs (rent, food, bills)\n‚Ä¢ 30% - Wants (entertainment, dining)\n‚Ä¢ 20% - Savings & Investments\n\nüéØ Age-based Guidelines:\n‚Ä¢ 20s: Save 25-30%\n‚Ä¢ 30s: Save 30-40%\n‚Ä¢ 40s: Save 40-50%\n\nTip: Increase savings by 5% whenever you get a raise!';
    }
    
    // Emergency Fund
    if (lowerQuestion.includes('emergency fund')) {
        return 'Emergency fund is essential for financial security!\n\nüéØ How Much to Save:\n‚Ä¢ Minimum: 3 months of expenses\n‚Ä¢ Recommended: 6 months of expenses\n‚Ä¢ Ideal: 9-12 months for self-employed\n\nüìä Calculation Example:\nIf monthly expenses = ‚Çπ40,000\nEmergency fund = ‚Çπ40,000 √ó 6 = ‚Çπ2,40,000\n\nüí° Where to Keep It:\n‚úÖ Liquid Mutual Funds (Best)\n‚úÖ High-interest Savings Account\n‚úÖ Fixed Deposits (Ladder approach)\n‚ùå NOT in stocks or long-term investments\n\n‚ö° Priority Order:\n1. Build emergency fund first\n2. Pay off high-interest debt\n3. Then invest in wealth creation';
    }
    
    // ELSS Tax Benefits
    if (lowerQuestion.includes('elss') || lowerQuestion.includes('tax')) {
        return 'ELSS (Equity Linked Savings Scheme) offers great tax benefits!\n\nüí∞ Tax Benefits:\n‚Ä¢ Deduction under Section 80C\n‚Ä¢ Up to ‚Çπ1.5 lakh deduction\n‚Ä¢ Saves ‚Çπ46,800 in tax (31.2% bracket)\n\n‚è∞ Lock-in Period:\n‚Ä¢ Shortest among 80C options: 3 years\n‚Ä¢ Can\'t withdraw before 3 years\n\nüìà Returns:\n‚Ä¢ Historical average: 12-15% annually\n‚Ä¢ Better than PPF, FD, NSC long-term\n\n‚úÖ Who Should Invest:\n‚Ä¢ Salaried individuals\n‚Ä¢ Looking for tax savings\n‚Ä¢ Comfortable with equity risk\n‚Ä¢ 3+ year investment horizon\n\n‚ö†Ô∏è Remember: Invest for returns, not just tax saving!';
    }
    
    // Stocks vs Mutual Funds
    if (lowerQuestion.includes('stock') && lowerQuestion.includes('mutual')) {
        return 'Stocks vs Mutual Funds - Key Differences:\n\nüìä Direct Stocks:\n‚úÖ Full control over portfolio\n‚úÖ No management fees\n‚úÖ Higher potential returns\n‚ùå Requires knowledge & time\n‚ùå Higher risk\n‚ùå Need minimum ‚Çπ50k-1L to diversify\n\nüìä Mutual Funds:\n‚úÖ Professional management\n‚úÖ Instant diversification\n‚úÖ Start with just ‚Çπ500\n‚úÖ Easy for beginners\n‚ùå Management fees (1-2%)\n‚ùå Less control\n\nüéØ My Recommendation:\n‚Ä¢ Beginners ‚Üí Mutual Funds\n‚Ä¢ Experienced ‚Üí Mix of both (70% MF, 30% Stocks)\n‚Ä¢ Experts ‚Üí Direct Stocks\n\nStart with mutual funds, learn, then add stocks!';
    }
    
    // Rupee Cost Averaging
    if (lowerQuestion.includes('rupee cost') || lowerQuestion.includes('averaging')) {
        return 'Rupee Cost Averaging is a powerful SIP benefit!\n\nüìâ How It Works:\nWhen you invest a fixed amount regularly:\n‚Ä¢ Market ‚Üì = Buy MORE units\n‚Ä¢ Market ‚Üë = Buy FEWER units\n‚Ä¢ Average cost = LOWER over time\n\nüí° Example:\n‚Çπ5,000 monthly SIP for 3 months:\n\nMonth 1: NAV ‚Çπ100 ‚Üí Buy 50 units\nMonth 2: NAV ‚Çπ80 ‚Üí Buy 62.5 units\nMonth 3: NAV ‚Çπ120 ‚Üí Buy 41.67 units\n\nTotal: 154.17 units for ‚Çπ15,000\nAverage cost: ‚Çπ97.30 (vs simple avg ‚Çπ100)\n\n‚úÖ Benefits:\n‚Ä¢ Removes emotion from investing\n‚Ä¢ No need to time the market\n‚Ä¢ Reduces impact of volatility\n‚Ä¢ Long-term wealth creation\n\nThis is why SIP works so well!';
    }
    
    // Default response
    return 'That\'s a great question! As an AI financial advisor, I\'m here to help.\n\nüí° I can assist you with:\n‚Ä¢ Investment strategies (SIP, lump sum, stocks)\n‚Ä¢ Mutual fund selection and categories\n‚Ä¢ Tax-saving options (ELSS, 80C)\n‚Ä¢ Emergency fund planning\n‚Ä¢ Portfolio diversification\n‚Ä¢ Savings strategies\n‚Ä¢ Risk assessment\n\nPlease ask me a specific question about any of these topics, or click on the sample questions on the right!\n\n‚ö†Ô∏è Disclaimer: This is educational information, not personalized financial advice. Consult a certified financial advisor for specific recommendations.';
}

function clearChat() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = `
        <div class="chat-message bot-message">
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <div class="message-text">
                    Hello! I'm InvestIQ, your AI financial advisor. I can help you with questions about stocks, mutual funds, savings strategies, and financial planning. What would you like to know?
                </div>
            </div>
        </div>
    `;
    chatHistory = [];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, '<br>');
}
</script>

{% endblock %}